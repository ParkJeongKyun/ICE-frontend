name: Deploy Repo
on:
  push:
    branches:
      - master
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v3
      - name: Set up Git user
        run: |
          git config --global user.name "ParkJeongKyun"
          git config --global user.email "dbzoseh84@gmail.com"
      - name: Install dependencies and build
        run: |
          npm ci
          npm run build
      - name: Deploy to private repo
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          # 설정: SSH 키 추가
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          # 비공개 레포지토리 클론 및 배포
          git clone git@github.com:ParkJeongKyun/ICE-frontend.git deploy-repo
          # deploy-repo 디렉토리 정리 (CNAME과 LICENSE 제외)
          shopt -s extglob
          rm -rf deploy-repo/!(CNAME|LICENSE)
          # dist 파일 복사
          cp -r dist/* deploy-repo/
          cd deploy-repo
          git add .
          git commit -m "Deploy on $(date '+%Y-%m-%d %H:%M:%S')"
          git push origin main
